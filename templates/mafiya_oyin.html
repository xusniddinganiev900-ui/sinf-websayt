<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafiya O'yini</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .mafiya-container { max-width: 800px; margin: 0 auto; padding: 20px; }

        /* Lobby */
        .lobby-box { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .room-code { font-size: 2.5em; font-weight: bold; color: #667eea; letter-spacing: 5px; text-align: center; margin: 20px 0; }
        .input-code { width: 200px; padding: 15px; font-size: 1.3em; text-align: center; border: 3px solid #667eea; border-radius: 15px; letter-spacing: 3px; text-transform: uppercase; }
        .players-list { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; justify-content: center; }
        .player-chip { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 20px; border-radius: 25px; display: flex; align-items: center; gap: 8px; }
        .player-chip.host::before { content: 'ğŸ‘‘'; }
        .player-chip.bot { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .player-chip.dead { opacity: 0.4; text-decoration: line-through; background: #666; }

        /* Buttons */
        .btn { padding: 15px 35px; border: none; border-radius: 25px; font-size: 1.1em; cursor: pointer; margin: 5px; transition: transform 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn-success { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }

        /* Game screens */
        .game-screen { display: none; }
        .game-screen.active { display: block; }

        /* Role card */
        .role-card { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; border-radius: 20px; padding: 40px; text-align: center; margin: 20px 0; }
        .role-icon { font-size: 5em; margin-bottom: 15px; }
        .role-name { font-size: 2em; font-weight: bold; margin-bottom: 10px; }
        .role-desc { opacity: 0.8; }

        /* Night/Day indicator */
        .phase-indicator { text-align: center; padding: 20px; border-radius: 15px; margin: 20px 0; }
        .phase-night { background: linear-gradient(135deg, #2c3e50, #1a252f); color: white; }
        .phase-day { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .phase-icon { font-size: 3em; }
        .phase-text { font-size: 1.5em; margin-top: 10px; }

        /* Target selection */
        .targets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin: 20px 0; }
        .target-card { background: white; border: 3px solid #e0e0e0; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .target-card:hover { border-color: #667eea; transform: scale(1.05); }
        .target-card.selected { border-color: #e74c3c; background: #fce4e4; }
        .target-card.dead { opacity: 0.3; pointer-events: none; }
        .target-avatar { font-size: 2.5em; margin-bottom: 10px; }
        .target-name { font-weight: bold; }

        /* Result screen */
        .result-box { background: white; border-radius: 20px; padding: 40px; text-align: center; }
        .winner-text { font-size: 2.5em; font-weight: bold; margin: 20px 0; }
        .winner-mafiya { color: #e74c3c; }
        .winner-fuqaro { color: #27ae60; }
        .roles-reveal { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin: 30px 0; }
        .role-reveal-card { background: #f8f9fa; border-radius: 10px; padding: 15px; text-align: center; }

        /* Message */
        .game-message { background: #e8f4fd; border-left: 4px solid #667eea; padding: 15px; border-radius: 10px; margin: 15px 0; }

        /* Voting */
        .votes-display { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0; }
        .vote-count { background: #f0f0f0; padding: 8px 15px; border-radius: 20px; }

        [data-theme="dark"] .lobby-box { background: #2d2d2d; }
        [data-theme="dark"] .target-card { background: #3d3d3d; border-color: #555; }
        [data-theme="dark"] .result-box { background: #2d2d2d; }
        [data-theme="dark"] .role-reveal-card { background: #3d3d3d; }
    </style>
</head>
<body class="app-body">
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar"><img src="{{ url_for('static', filename='images/' + (foydalanuvchi.avatar if foydalanuvchi.avatar else 'ogil.svg')) }}" alt="Avatar"></div>
                <h3>{{ ism }}</h3>
                <p class="ball-display">{{ foydalanuvchi.ball }} ball</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="{{ url_for('home') }}"><span class="icon">ğŸ </span> Home</a></li>
                <li class="nav-item"><a href="{{ url_for('oyin') }}"><span class="icon">ğŸ®</span> O'yinlar</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="{{ url_for('chiqish') }}" class="logout-btn"><span class="icon">ğŸšª</span> Chiqish</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="mafiya-container">
                <h1>ğŸ”ª Mafiya O'yini</h1>

                <!-- Asosiy menyu -->
                <div id="menuScreen" class="game-screen active">
                    <div class="lobby-box">
                        <h2 style="text-align: center;">O'yinni boshlash</h2>
                        <p style="text-align: center; color: #666; margin-bottom: 30px;">4-10 o'yinchi kerak</p>

                        <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                            <button class="btn btn-primary" onclick="yaratishXona()">ğŸ  Yangi xona yaratish</button>

                            <div style="text-align: center;">
                                <p style="margin-bottom: 10px;">yoki xonaga qo'shiling:</p>
                                <input type="text" class="input-code" id="roomCodeInput" placeholder="ABCD12" maxlength="6">
                                <br><br>
                                <button class="btn btn-success" onclick="qoshilishXona()">ğŸšª Qo'shilish</button>
                            </div>
                        </div>

                        <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                            <h3>ğŸ“œ Qoidalar:</h3>
                            <ul style="line-height: 1.8; color: #666;">
                                <li><strong>Mafiya ğŸ”ª</strong> - Kechasi biror kishini o'ldiradi</li>
                                <li><strong>Doktor ğŸ’‰</strong> - Kechasi biror kishini saqlaydi</li>
                                <li><strong>Sheriff ğŸ”</strong> - Kechasi biror kishini tekshiradi</li>
                                <li><strong>Fuqaro ğŸ‘¤</strong> - Kunduzi muhokama qiladi va ovoz beradi</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Kutish xonasi -->
                <div id="lobbyScreen" class="game-screen">
                    <div class="lobby-box">
                        <h2 style="text-align: center;">Xona kodi:</h2>
                        <div class="room-code" id="displayRoomCode">ABCD12</div>

                        <p style="text-align: center; color: #666;">O'yinchilar (<span id="playerCount">0</span>/10):</p>
                        <div class="players-list" id="playersList"></div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-warning" id="addBotBtn" onclick="botQoshish()" style="display: none;">ğŸ¤– Bot qo'shish</button>
                            <button class="btn btn-success" id="startBtn" onclick="boshlashOyin()" style="display: none;">ğŸš€ O'yinni boshlash</button>
                            <button class="btn btn-danger" onclick="chiqishXona()">ğŸšª Chiqish</button>
                        </div>

                        <p id="waitingMsg" style="text-align: center; color: #999; margin-top: 20px;">Host o'yinni boshlashini kuting...</p>
                        <p id="botHint" style="text-align: center; color: #f39c12; margin-top: 10px; display: none;">ğŸ’¡ Yetarli o'yinchi yo'qmi? Bot qo'shing!</p>
                    </div>
                </div>

                <!-- Rol ko'rsatish -->
                <div id="roleScreen" class="game-screen">
                    <div class="role-card" id="roleCard">
                        <div class="role-icon" id="roleIcon">ğŸ”ª</div>
                        <div class="role-name" id="roleName">Mafiya</div>
                        <div class="role-desc" id="roleDesc">Kechasi odamlarni o'ldiradi</div>
                    </div>
                    <p style="text-align: center; color: #666;">Rolingizni yashiring!</p>
                </div>

                <!-- Kecha ekrani -->
                <div id="nightScreen" class="game-screen">
                    <div class="phase-indicator phase-night">
                        <div class="phase-icon">ğŸŒ™</div>
                        <div class="phase-text">Kecha <span id="nightNumber">1</span></div>
                    </div>

                    <div id="nightAction" style="text-align: center;">
                        <h3 id="nightActionTitle">Nishonni tanlang</h3>
                        <div class="targets-grid" id="nightTargets"></div>
                        <button class="btn btn-danger" id="nightActionBtn" onclick="kechaHarakat()" disabled>Tasdiqlash</button>
                    </div>

                    <div id="nightWaiting" style="display: none; text-align: center; padding: 40px;">
                        <div style="font-size: 3em;">ğŸ˜´</div>
                        <p>Siz uxlayapsiz... Tong otishini kuting</p>
                    </div>

                    <div class="game-message" id="nightMessage" style="display: none;"></div>
                </div>

                <!-- Kunduz ekrani -->
                <div id="dayScreen" class="game-screen">
                    <div class="phase-indicator phase-day">
                        <div class="phase-icon">â˜€ï¸</div>
                        <div class="phase-text">Kunduz</div>
                    </div>

                    <div class="game-message" id="dayMessage"></div>

                    <h3 style="text-align: center;">Kimni chiqaramiz?</h3>
                    <div class="targets-grid" id="dayTargets"></div>

                    <div class="votes-display" id="votesDisplay"></div>

                    <div style="text-align: center;">
                        <button class="btn btn-warning" id="voteBtn" onclick="ovozBerish()" disabled>ğŸ—³ï¸ Ovoz berish</button>
                    </div>
                </div>

                <!-- Natija ekrani -->
                <div id="resultScreen" class="game-screen">
                    <div class="result-box">
                        <div style="font-size: 5em;" id="resultIcon">ğŸ‰</div>
                        <div class="winner-text" id="winnerText">Fuqarolar g'alaba qildi!</div>

                        <h3>Rollar:</h3>
                        <div class="roles-reveal" id="rolesReveal"></div>

                        <button class="btn btn-primary" onclick="qaytishMenu()">ğŸ  Menuga qaytish</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const socket = io();
        const myName = "{{ ism }}";
        let currentRoom = null;
        let myRole = null;
        let selectedTarget = null;
        let isHost = false;
        let alivePlayers = [];

        // Xona yaratish
        function yaratishXona() {
            socket.emit('mafiya_xona_yaratish', {});
        }

        // Xonaga qo'shilish
        function qoshilishXona() {
            const code = document.getElementById('roomCodeInput').value.toUpperCase();
            if (code.length !== 6) {
                alert('6 ta belgi kiriting!');
                return;
            }
            socket.emit('mafiya_qoshilish', {room_code: code});
        }

        // O'yinni boshlash
        function boshlashOyin() {
            socket.emit('mafiya_boshlash', {room_code: currentRoom});
        }

        // Bot qo'shish
        function botQoshish() {
            socket.emit('mafiya_bot_qoshish', {room_code: currentRoom});
        }

        // Xonadan chiqish
        function chiqishXona() {
            socket.emit('mafiya_xonadan_chiqish', {room_code: currentRoom});
            showScreen('menuScreen');
            currentRoom = null;
        }

        // Kecha harakati
        function kechaHarakat() {
            if (!selectedTarget) return;
            socket.emit('mafiya_kecha_harakat', {room_code: currentRoom, target: selectedTarget});
            document.getElementById('nightActionBtn').disabled = true;
            document.getElementById('nightMessage').style.display = 'block';
            document.getElementById('nightMessage').textContent = 'Tanlovingiz qabul qilindi. Kuting...';
        }

        // Ovoz berish
        function ovozBerish() {
            if (!selectedTarget) return;
            socket.emit('mafiya_ovoz_berish', {room_code: currentRoom, target: selectedTarget});
            document.getElementById('voteBtn').disabled = true;
        }

        // Menuga qaytish
        function qaytishMenu() {
            showScreen('menuScreen');
            currentRoom = null;
            myRole = null;
        }

        // Ekranni ko'rsatish
        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // O'yinchilar ro'yxatini yangilash
        function updatePlayersList(players, host) {
            const list = document.getElementById('playersList');
            list.innerHTML = players.map(p =>
                `<div class="player-chip ${p === host ? 'host' : ''} ${p.includes('ğŸ¤–') ? 'bot' : ''} ${!alivePlayers.includes(p) && alivePlayers.length > 0 ? 'dead' : ''}">${p}</div>`
            ).join('');
            document.getElementById('playerCount').textContent = players.length;

            isHost = (host === myName);
            document.getElementById('startBtn').style.display = isHost ? 'inline-block' : 'none';
            document.getElementById('addBotBtn').style.display = isHost && players.length < 10 ? 'inline-block' : 'none';
            document.getElementById('waitingMsg').style.display = isHost ? 'none' : 'block';
            document.getElementById('botHint').style.display = isHost && players.length < 4 ? 'block' : 'none';
        }

        // Nishonlarni ko'rsatish
        function showTargets(containerId, players, excludeSelf = false) {
            const container = document.getElementById(containerId);
            const targets = excludeSelf ? players.filter(p => p !== myName) : players;

            container.innerHTML = targets.map(p => `
                <div class="target-card ${!alivePlayers.includes(p) ? 'dead' : ''}" onclick="selectTarget('${p}', this)">
                    <div class="target-avatar">ğŸ‘¤</div>
                    <div class="target-name">${p}</div>
                </div>
            `).join('');

            selectedTarget = null;
        }

        // Nishon tanlash
        function selectTarget(name, el) {
            document.querySelectorAll('.target-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedTarget = name;
            document.getElementById('nightActionBtn').disabled = false;
            document.getElementById('voteBtn').disabled = false;
        }

        // Socket events
        socket.on('mafiya_xona_yaratildi', (data) => {
            currentRoom = data.room_code;
            document.getElementById('displayRoomCode').textContent = data.room_code;
            updatePlayersList([myName], myName);
            showScreen('lobbyScreen');
        });

        socket.on('mafiya_qoshildi', (data) => {
            currentRoom = data.room_code;
            document.getElementById('displayRoomCode').textContent = data.room_code;
            updatePlayersList(data.players, data.host);
            showScreen('lobbyScreen');
        });

        socket.on('mafiya_xato', (data) => {
            alert(data.xabar);
        });

        socket.on('mafiya_rol_berildi', (data) => {
            myRole = data.rol;
            document.getElementById('roleIcon').textContent = data.rol_info.icon;
            document.getElementById('roleName').textContent = data.rol_info.nomi;
            document.getElementById('roleDesc').textContent = data.rol_info.tavsif;

            // Rol rangini o'zgartirish
            const roleCard = document.getElementById('roleCard');
            if (data.rol === 'mafiya') {
                roleCard.style.background = 'linear-gradient(135deg, #c0392b, #e74c3c)';
            } else if (data.rol === 'doktor') {
                roleCard.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
            } else if (data.rol === 'sheriff') {
                roleCard.style.background = 'linear-gradient(135deg, #2980b9, #3498db)';
            }

            showScreen('roleScreen');

            setTimeout(() => {
                showNightScreen(data.kecha);
            }, 3000);
        });

        socket.on('mafiya_boshlandi', (data) => {
            alivePlayers = data.tirik_oyinchilar;
        });

        function showNightScreen(kecha) {
            document.getElementById('nightNumber').textContent = kecha;
            document.getElementById('nightMessage').style.display = 'none';

            if (myRole === 'mafiya' || myRole === 'doktor' || myRole === 'sheriff') {
                document.getElementById('nightAction').style.display = 'block';
                document.getElementById('nightWaiting').style.display = 'none';

                let title = '';
                if (myRole === 'mafiya') title = 'ğŸ”ª Kimni o\'ldiramiz?';
                else if (myRole === 'doktor') title = 'ğŸ’‰ Kimni saqlaysiz?';
                else if (myRole === 'sheriff') title = 'ğŸ” Kimni tekshirasiz?';

                document.getElementById('nightActionTitle').textContent = title;
                showTargets('nightTargets', alivePlayers, myRole !== 'doktor');
            } else {
                document.getElementById('nightAction').style.display = 'none';
                document.getElementById('nightWaiting').style.display = 'block';
            }

            showScreen('nightScreen');
        }

        socket.on('mafiya_harakat_qabul', (data) => {
            document.getElementById('nightMessage').style.display = 'block';
            document.getElementById('nightMessage').textContent = data.xabar;
        });

        socket.on('mafiya_sheriff_natija', (data) => {
            document.getElementById('nightMessage').style.display = 'block';
            document.getElementById('nightMessage').innerHTML = `<strong>${data.xabar}</strong>`;
            document.getElementById('nightMessage').style.background = data.natija === 'mafiya' ? '#fce4e4' : '#d5f4e6';
        });

        socket.on('mafiya_kunduz', (data) => {
            alivePlayers = data.tirik_oyinchilar;

            let msg = '';
            if (data.olgan) {
                msg = `ğŸ˜µ ${data.olgan} kechasi o'ldirildi!`;
            } else {
                msg = 'ğŸŒŸ Bu kecha hech kim o\'lmadi!';
            }
            document.getElementById('dayMessage').textContent = msg;

            showTargets('dayTargets', alivePlayers, true);
            document.getElementById('votesDisplay').innerHTML = '';
            document.getElementById('voteBtn').disabled = true;
            selectedTarget = null;

            showScreen('dayScreen');
        });

        socket.on('mafiya_kecha', (data) => {
            alivePlayers = data.tirik_oyinchilar;

            if (data.chiqarilgan) {
                alert(`ğŸ“¢ ${data.chiqarilgan} chiqarib yuborildi!`);
            } else {
                alert('Ovozlar teng bo\'ldi, hech kim chiqarilmadi!');
            }

            showNightScreen(data.kecha);
        });

        socket.on('mafiya_ovoz_yangilandi', (data) => {
            document.getElementById('votesDisplay').innerHTML = `<div class="vote-count">Ovozlar: ${data.ovoz_soni}/${data.jami}</div>`;
        });

        socket.on('mafiya_tugadi', (data) => {
            const resultIcon = document.getElementById('resultIcon');
            const winnerText = document.getElementById('winnerText');

            if (data.winner === 'mafiya') {
                resultIcon.textContent = 'ğŸ”ª';
                winnerText.textContent = 'Mafiya g\'alaba qildi!';
                winnerText.className = 'winner-text winner-mafiya';
            } else {
                resultIcon.textContent = 'ğŸ‰';
                winnerText.textContent = 'Fuqarolar g\'alaba qildi!';
                winnerText.className = 'winner-text winner-fuqaro';
            }

            // Rollarni ko'rsatish
            const rolesReveal = document.getElementById('rolesReveal');
            rolesReveal.innerHTML = Object.entries(data.rollar).map(([name, rol]) => `
                <div class="role-reveal-card">
                    <div style="font-size: 1.5em;">${rol === 'mafiya' ? 'ğŸ”ª' : rol === 'doktor' ? 'ğŸ’‰' : rol === 'sheriff' ? 'ğŸ”' : 'ğŸ‘¤'}</div>
                    <div style="font-weight: bold;">${name}</div>
                    <div style="color: ${rol === 'mafiya' ? '#e74c3c' : '#27ae60'};">${rol}</div>
                </div>
            `).join('');

            showScreen('resultScreen');
        });

        socket.on('mafiya_oyinchi_chiqdi', (data) => {
            updatePlayersList(data.players, data.host);
        });
    </script>
</body>
</html>
