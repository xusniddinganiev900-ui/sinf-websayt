<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xotira O'yini</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .game-container { max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; }
        .stats-bar { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-item { background: white; padding: 10px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .cards-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            max-width: 400px; margin: 20px auto;
        }
        .card {
            aspect-ratio: 1; background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-size: 2em; transition: transform 0.3s;
            position: relative;
        }
        .card:hover { transform: scale(1.05); }
        .card .front, .card .back {
            position: absolute; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; backface-visibility: hidden;
        }
        .card .back { background: linear-gradient(135deg, #667eea, #764ba2); }
        .card .front { background: white; transform: rotateY(180deg); }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { opacity: 0.5; pointer-events: none; }
        .btn-start {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white;
            border: none; padding: 20px 50px; border-radius: 30px; font-size: 1.3em; cursor: pointer;
        }
        .result-screen { display: none; }
        .result-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        [data-theme="dark"] .stat-item { background: #2d2d2d; }
        [data-theme="dark"] .card .front { background: #2d2d2d; }
        [data-theme="dark"] .result-box { background: #2d2d2d; }
    </style>
</head>
<body class="app-body">
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar"><img src="{{ url_for('static', filename='images/' + (foydalanuvchi.avatar if foydalanuvchi.avatar else 'ogil.svg')) }}" alt="Avatar"></div>
                <h3>{{ ism }}</h3>
                <p class="ball-display">{{ foydalanuvchi.ball }} ball</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="{{ url_for('home') }}"><span class="icon">üè†</span> Home</a></li>
                <li class="nav-item"><a href="{{ url_for('oyin') }}"><span class="icon">üéÆ</span> O'yinlar</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="{{ url_for('chiqish') }}" class="logout-btn"><span class="icon">üö™</span> Chiqish</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="game-container">
                <h1>üß† Xotira O'yini</h1>
                <p>Bir xil kartalarni toping!</p>

                <div id="startScreen">
                    <button class="btn-start" onclick="startGame()">üöÄ Boshlash</button>
                </div>

                <div id="gameScreen" style="display: none;">
                    <div class="stats-bar">
                        <div class="stat-item">
                            <div class="stat-value" id="moves">0</div>
                            <div>Urinishlar</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="matches">0</div>
                            <div>Topildi</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="timer">0</div>
                            <div>Soniya</div>
                        </div>
                    </div>

                    <div class="cards-grid" id="cardsGrid"></div>
                </div>

                <div id="resultScreen" class="result-screen">
                    <div class="result-box">
                        <h2>üéâ Tabriklaymiz!</h2>
                        <p><strong id="finalMoves">0</strong> urinishda topdingiz!</p>
                        <p><strong id="finalTime">0</strong> soniyada</p>
                        <p style="color: #27ae60; font-size: 1.3em;" id="earnedBall">+0 ball</p>
                        <button class="btn-start" onclick="location.reload()">üîÑ Qayta o'ynash</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const emojis = ['üçé', 'üçä', 'üçã', 'üçá', 'üçì', 'üçí', 'ü•ù', 'üçë'];
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let gameTimer;
        let seconds = 0;
        let canFlip = true;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            cards = shuffle([...emojis, ...emojis]);
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = cards.map((emoji, i) =>
                `<div class="card" onclick="flipCard(${i})">
                    <div class="back">‚ùì</div>
                    <div class="front">${emoji}</div>
                </div>`
            ).join('');

            gameTimer = setInterval(() => {
                seconds++;
                document.getElementById('timer').textContent = seconds;
            }, 1000);
        }

        function flipCard(index) {
            if (!canFlip) return;
            const card = document.querySelectorAll('.card')[index];
            if (card.classList.contains('flipped') || card.classList.contains('matched')) return;

            card.classList.add('flipped');
            flippedCards.push({index, emoji: cards[index], element: card});

            if (flippedCards.length === 2) {
                moves++;
                document.getElementById('moves').textContent = moves;
                canFlip = false;

                if (flippedCards[0].emoji === flippedCards[1].emoji) {
                    flippedCards.forEach(c => c.element.classList.add('matched'));
                    matchedPairs++;
                    document.getElementById('matches').textContent = matchedPairs;
                    flippedCards = [];
                    canFlip = true;

                    if (matchedPairs === emojis.length) {
                        endGame();
                    }
                } else {
                    setTimeout(() => {
                        flippedCards.forEach(c => c.element.classList.remove('flipped'));
                        flippedCards = [];
                        canFlip = true;
                    }, 1000);
                }
            }
        }

        function endGame() {
            clearInterval(gameTimer);
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            document.getElementById('finalMoves').textContent = moves;
            document.getElementById('finalTime').textContent = seconds;

            fetch('/xotira_yakunla', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({urinishlar: moves, vaqt: seconds})
            }).then(r => r.json()).then(data => {
                document.getElementById('earnedBall').textContent = `+${data.ball} ball`;
            });
        }
    </script>
</body>
</html>
