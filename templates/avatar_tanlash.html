<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Tanlash</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .avatar-container { max-width: 700px; margin: 0 auto; padding: 20px; }
        .current-avatar {
            text-align: center; margin-bottom: 30px; padding: 30px;
            background: white; border-radius: 20px; box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .current-avatar img { width: 120px; height: 120px; border-radius: 50%; margin-bottom: 15px; }
        .avatar-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; margin: 20px 0;
        }
        .avatar-item {
            background: white; border-radius: 15px; padding: 15px; text-align: center;
            cursor: pointer; transition: all 0.3s; border: 3px solid transparent;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .avatar-item:hover { transform: scale(1.05); border-color: #667eea; }
        .avatar-item.selected { border-color: #27ae60; background: #f0fff4; }
        .avatar-item img { width: 70px; height: 70px; }
        .avatar-name { font-size: 0.85em; margin-top: 8px; color: #666; }
        .btn-save {
            display: block; width: 100%; max-width: 300px; margin: 30px auto;
            background: linear-gradient(135deg, #27ae60, #2ecc71); color: white;
            border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; cursor: pointer;
        }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
        .success-msg { text-align: center; color: #27ae60; margin: 15px 0; display: none; }
        [data-theme="dark"] .current-avatar { background: #2d2d2d; }
        [data-theme="dark"] .avatar-item { background: #2d2d2d; }
        [data-theme="dark"] .avatar-item.selected { background: #1a3d1a; }
    </style>
</head>
<body class="app-body">
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar"><img src="{{ url_for('static', filename='images/' + (foydalanuvchi.avatar if foydalanuvchi.avatar else 'ogil.svg')) }}" alt="Avatar"></div>
                <h3>{{ ism }}</h3>
                <p class="ball-display">{{ foydalanuvchi.ball }} ball</p>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="{{ url_for('home') }}"><span class="icon">üè†</span> Home</a></li>
                <li class="nav-item"><a href="{{ url_for('kabinet') }}"><span class="icon">üë§</span> Kabinet</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="{{ url_for('chiqish') }}" class="logout-btn"><span class="icon">üö™</span> Chiqish</a>
            </div>
        </nav>

        <main class="main-content">
            <div class="avatar-container">
                <h1>üë§ Avatar Tanlash</h1>

                <div class="current-avatar">
                    <img src="{{ url_for('static', filename='images/' + (foydalanuvchi.avatar if foydalanuvchi.avatar else 'ogil.svg')) }}" alt="Current Avatar" id="currentImg">
                    <h3>Joriy avatar</h3>
                </div>

                <h3>Mavjud avatarlar:</h3>
                <div class="avatar-grid">
                    {% for avatar in avatarlar %}
                    <div class="avatar-item {% if foydalanuvchi.avatar == avatar %}selected{% endif %}"
                         onclick="selectAvatar('{{ avatar }}', this)">
                        <img src="{{ url_for('static', filename='images/' + avatar) }}" alt="{{ avatar }}">
                        <div class="avatar-name">{{ avatar.replace('.svg', '').replace('_', ' ').title() }}</div>
                    </div>
                    {% endfor %}
                </div>

                <div class="success-msg" id="successMsg">‚úÖ Avatar saqlandi!</div>
                <button class="btn-save" id="saveBtn" onclick="saveAvatar()" disabled>üíæ Saqlash</button>
            </div>
        </main>
    </div>

    <script>
        let selectedAvatar = '{{ foydalanuvchi.avatar if foydalanuvchi.avatar else "ogil.svg" }}';

        function selectAvatar(avatar, el) {
            selectedAvatar = avatar;
            document.querySelectorAll('.avatar-item').forEach(item => item.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('currentImg').src = `/static/images/${avatar}`;
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('successMsg').style.display = 'none';
        }

        function saveAvatar() {
            fetch('/avatar_saqlash', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({avatar: selectedAvatar})
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    document.getElementById('successMsg').style.display = 'block';
                    document.getElementById('saveBtn').disabled = true;
                    // Sidebar avatarni yangilash
                    document.querySelector('.user-avatar img').src = `/static/images/${selectedAvatar}`;
                }
            });
        }
    </script>
</body>
</html>
