<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnirlar - Sinfimiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .turnir-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .turnir-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .turnir-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .turnir-tab {
            padding: 12px 25px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s;
        }
        .turnir-tab.kunlik { background: linear-gradient(135deg, #f39c12, #e74c3c); }
        .turnir-tab.haftalik { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .turnir-tab.oylik { background: linear-gradient(135deg, #3498db, #2980b9); }
        .turnir-tab.mavsumiy { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .turnir-tab.active { transform: scale(1.1); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .turnir-tab:hover { transform: scale(1.05); }

        .turnir-info {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .turnir-info h2 {
            color: #333;
            margin-bottom: 15px;
        }
        .turnir-countdown {
            font-size: 1.5em;
            color: #e74c3c;
            margin: 15px 0;
        }

        .rasm-container {
            text-align: center;
            margin: 20px 0;
        }
        .rasm-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .rasm-placeholder {
            background: linear-gradient(135deg, #ddd, #eee);
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            color: #999;
            font-size: 1.2em;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
        }
        #drawingCanvas {
            border: 3px solid #667eea;
            border-radius: 15px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }

        .tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .tool-btn:hover { transform: scale(1.05); }
        .color-picker {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        .size-slider {
            width: 100px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 20px 0;
        }
        .submit-btn:hover { transform: scale(1.05); }

        .ishtirokchilar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .ishtirokchi-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        .ishtirokchi-card:hover { transform: translateY(-5px); }
        .ishtirokchi-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .ishtirokchi-info {
            padding: 15px;
        }
        .ishtirokchi-info h4 { color: #333; margin-bottom: 5px; }
        .ishtirokchi-info p { color: #666; font-size: 0.9em; }
        .ovoz-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 10px;
        }
        .ovoz-btn:disabled {
            background: #ccc;
            cursor: default;
        }

        .golib-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2em;
        }
        .golib-1 { color: gold; }
        .golib-2 { color: silver; }
        .golib-3 { color: #cd7f32; }

        /* Admin panel */
        .admin-panel {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            color: white;
        }
        .admin-panel h3 { margin-bottom: 20px; }
        .admin-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1em;
        }
        .admin-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px;
        }
        .admin-btn.success { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .golib-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .golib-select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border-radius: 10px;
            border: none;
        }
        .coin-input {
            width: 100px;
            padding: 10px;
            border-radius: 10px;
            border: none;
        }

        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .turnir-tabs { flex-direction: column; align-items: center; }
            #drawingCanvas { width: 100% !important; height: auto !important; }
        }
    </style>
</head>
<body style="background: #f5f6fa; min-height: 100vh;">
    <div class="turnir-container">
        <a href="{{ url_for('home') }}" class="back-btn">‚Üê Orqaga</a>

        <div class="turnir-header">
            <h1>üèÜ Turnirlar</h1>
            <p>Rasmlar musobaqasida ishtirok eting va mukofotlar yutib oling!</p>
        </div>

        <div class="turnir-tabs">
            <a href="{{ url_for('turnirlar', tur='kunlik') }}" class="turnir-tab kunlik {{ 'active' if tur == 'kunlik' else '' }}">üèÜ Kunlik (1 kun)</a>
            <a href="{{ url_for('turnirlar', tur='haftalik') }}" class="turnir-tab haftalik {{ 'active' if tur == 'haftalik' else '' }}">ü•á Haftalik (7 kun)</a>
            <a href="{{ url_for('turnirlar', tur='oylik') }}" class="turnir-tab oylik {{ 'active' if tur == 'oylik' else '' }}">üèÖ Oylik (30 kun)</a>
            <a href="{{ url_for('turnirlar', tur='mavsumiy') }}" class="turnir-tab mavsumiy {{ 'active' if tur == 'mavsumiy' else '' }}">üëë Mavsumiy (90 kun)</a>
        </div>

        {% if is_admin %}
        <!-- Admin Panel -->
        <div class="admin-panel">
            <h3>üëë Admin Panel</h3>

            <div style="margin-bottom: 20px;">
                <h4>Rasm yuklash:</h4>
                <input type="file" id="turnirRasm" accept="image/*" class="admin-input" style="background: white; color: #333;">
                <button onclick="rasmYuklash()" class="admin-btn success">Rasm yuklash</button>
            </div>

            <div style="margin-bottom: 20px;">
                <h4>Yoki Paint bilan chizish:</h4>
                <canvas id="adminCanvas" width="400" height="300" style="background: white; border-radius: 10px; cursor: crosshair;"></canvas>
                <div class="tools" style="margin-top: 10px;">
                    <input type="color" id="adminColor" value="#000000" class="color-picker">
                    <input type="range" id="adminSize" min="1" max="30" value="5" class="size-slider">
                    <button onclick="adminTozalash()" class="tool-btn" style="background: #e74c3c; color: white;">Tozalash</button>
                    <button onclick="adminRasmSaqlash()" class="admin-btn success">Bu rasmni qo'yish</button>
                </div>
            </div>

            {% if turnir and turnir.ishtirokchilar|length > 0 %}
            <div>
                <h4>G'oliblarni tanlash va coin berish:</h4>
                <div class="golib-form">
                    <div>
                        <label>ü•á 1-o'rin:</label>
                        <select id="golib1" class="golib-select">
                            <option value="">Tanlang...</option>
                            {% for ish in turnir.ishtirokchilar %}
                            <option value="{{ ish.ism }}" {{ 'selected' if turnir.goliblar and turnir.goliblar.golib1 == ish.ism else '' }}>{{ ish.ism }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" id="coin1" class="coin-input" placeholder="Coin" value="{{ turnir.goliblar.coin1 if turnir.goliblar else 100 }}">
                    </div>
                    <div>
                        <label>ü•à 2-o'rin:</label>
                        <select id="golib2" class="golib-select">
                            <option value="">Tanlang...</option>
                            {% for ish in turnir.ishtirokchilar %}
                            <option value="{{ ish.ism }}" {{ 'selected' if turnir.goliblar and turnir.goliblar.golib2 == ish.ism else '' }}>{{ ish.ism }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" id="coin2" class="coin-input" placeholder="Coin" value="{{ turnir.goliblar.coin2 if turnir.goliblar else 50 }}">
                    </div>
                    <div>
                        <label>ü•â 3-o'rin:</label>
                        <select id="golib3" class="golib-select">
                            <option value="">Tanlang...</option>
                            {% for ish in turnir.ishtirokchilar %}
                            <option value="{{ ish.ism }}" {{ 'selected' if turnir.goliblar and turnir.goliblar.golib3 == ish.ism else '' }}>{{ ish.ism }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" id="coin3" class="coin-input" placeholder="Coin" value="{{ turnir.goliblar.coin3 if turnir.goliblar else 25 }}">
                    </div>
                </div>
                <button onclick="goliblarniSaqlash()" class="admin-btn success" style="margin-top: 15px;">G'oliblarni saqlash va coin berish</button>
            </div>
            {% endif %}

            <div style="margin-top: 20px;">
                <button onclick="turnirniYangilash()" class="admin-btn">Yangi turnir boshlash</button>
            </div>
        </div>
        {% endif %}

        <div class="turnir-info">
            <h2>
                {% if tur == 'kunlik' %}üèÜ Kunlik Turnir{% endif %}
                {% if tur == 'haftalik' %}ü•á Haftalik Turnir{% endif %}
                {% if tur == 'oylik' %}üèÖ Oylik Turnir{% endif %}
                {% if tur == 'mavsumiy' %}üëë Mavsumiy Liga{% endif %}
            </h2>

            <p>
                {% if tur == 'kunlik' %}Har kuni yangi rasm! Eng yaxshi chizgan 3 ta ishtirokchi mukofotlanadi.{% endif %}
                {% if tur == 'haftalik' %}Haftalik musobaqa! 7 kun davomida eng yaxshi rasm chizganlar g'olib bo'ladi.{% endif %}
                {% if tur == 'oylik' %}Oylik katta turnir! 30 kun davomida ishtirok eting.{% endif %}
                {% if tur == 'mavsumiy' %}Mavsumiy liga - 90 kunlik katta musobaqa! Eng katta mukofotlar!{% endif %}
            </p>

            {% if turnir %}
            <div class="turnir-countdown" id="countdown">
                Tugashiga: <span id="qolgan_vaqt">Hisoblanmoqda...</span>
            </div>

            <div class="rasm-container">
                {% if turnir.rasm %}
                <h3>Bu rasmni chizing:</h3>
                <img src="{{ turnir.rasm }}" alt="Turnir rasmi" id="namuna_rasm">
                {% else %}
                <div class="rasm-placeholder">
                    Admin hali rasm qo'ymagan
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="rasm-placeholder">
                Hozircha faol turnir yo'q. Admin yangi turnir boshlashi kerak.
            </div>
            {% endif %}
        </div>

        {% if turnir and turnir.rasm %}
        <!-- Chizish canvasi -->
        <div class="turnir-info">
            <h3>Sizning rasmingiz:</h3>

            {% if user_submitted %}
            <div style="text-align: center; padding: 30px; background: #e8f5e9; border-radius: 15px;">
                <span style="font-size: 3em;">‚úÖ</span>
                <h3 style="color: #27ae60;">Siz allaqachon ishtirok etdingiz!</h3>
                <p>Natijalarni kuting...</p>
            </div>
            {% else %}
            <div class="canvas-container">
                <canvas id="drawingCanvas" width="500" height="400"></canvas>
            </div>

            <div class="tools">
                <input type="color" id="colorPicker" value="#000000" class="color-picker" title="Rang tanlash">
                <label>Qalinlik: <input type="range" id="brushSize" min="1" max="30" value="5" class="size-slider"></label>
                <button onclick="clearCanvas()" class="tool-btn" style="background: #e74c3c; color: white;">üóë Tozalash</button>
                <button onclick="undoLast()" class="tool-btn" style="background: #f39c12; color: white;">‚Ü© Ortga</button>
            </div>

            <div style="text-align: center;">
                <button onclick="rasmniYuborish()" class="submit-btn">üì§ Rasmni yuborish</button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Ishtirokchilar -->
        {% if turnir and turnir.ishtirokchilar|length > 0 %}
        <div class="turnir-info">
            <h3>Ishtirokchilar ({{ turnir.ishtirokchilar|length }} ta)</h3>
            <div class="ishtirokchilar">
                {% for ish in turnir.ishtirokchilar %}
                <div class="ishtirokchi-card" style="position: relative;">
                    {% if turnir.goliblar %}
                        {% if turnir.goliblar.golib1 == ish.ism %}
                        <span class="golib-badge golib-1">ü•á</span>
                        {% elif turnir.goliblar.golib2 == ish.ism %}
                        <span class="golib-badge golib-2">ü•à</span>
                        {% elif turnir.goliblar.golib3 == ish.ism %}
                        <span class="golib-badge golib-3">ü•â</span>
                        {% endif %}
                    {% endif %}
                    <img src="{{ ish.rasm }}" alt="{{ ish.ism }} rasmi">
                    <div class="ishtirokchi-info">
                        <h4>{{ ish.ism }}</h4>
                        <p>{{ ish.vaqt }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- G'oliblar tarixi -->
        {% if tarix and tarix|length > 0 %}
        <div class="turnir-info">
            <h3>O'tgan turnirlar g'oliblari</h3>
            {% for t in tarix[-5:]|reverse %}
            <div style="padding: 15px; border-bottom: 1px solid #eee;">
                <strong>{{ t.sana }}</strong>
                <div style="margin-top: 10px;">
                    {% if t.goliblar %}
                    <span>ü•á {{ t.goliblar.golib1 or '-' }} (+{{ t.goliblar.coin1 or 0 }})</span>
                    <span>ü•à {{ t.goliblar.golib2 or '-' }} (+{{ t.goliblar.coin2 or 0 }})</span>
                    <span>ü•â {{ t.goliblar.golib3 or '-' }} (+{{ t.goliblar.coin3 or 0 }})</span>
                    {% else %}
                    <span>G'oliblar tanlanmagan</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <script>
        // Canvas drawing
        const canvas = document.getElementById('drawingCanvas');
        let ctx, isDrawing = false, lastX = 0, lastY = 0, history = [];

        if (canvas) {
            ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch support
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.lineWidth = document.getElementById('brushSize').value;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();

            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            if (e.type === 'touchstart') {
                isDrawing = true;
                [lastX, lastY] = [x, y];
            } else if (e.type === 'touchmove' && isDrawing) {
                ctx.strokeStyle = document.getElementById('colorPicker').value;
                ctx.lineWidth = document.getElementById('brushSize').value;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }
        }

        function saveState() {
            history.push(canvas.toDataURL());
            if (history.length > 20) history.shift();
        }

        function undoLast() {
            if (history.length > 1) {
                history.pop();
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = history[history.length - 1];
            }
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();
        }

        function rasmniYuborish() {
            const dataUrl = canvas.toDataURL('image/png');

            fetch('/turnir/yuborish', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tur: '{{ tur }}',
                    rasm: dataUrl
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Rasmingiz qabul qilindi! Omad!');
                    location.reload();
                } else {
                    alert(data.xato || 'Xatolik yuz berdi');
                }
            });
        }

        // Admin canvas
        const adminCanvas = document.getElementById('adminCanvas');
        let adminCtx, adminDrawing = false, adminLastX = 0, adminLastY = 0;

        if (adminCanvas) {
            adminCtx = adminCanvas.getContext('2d');
            adminCtx.fillStyle = 'white';
            adminCtx.fillRect(0, 0, adminCanvas.width, adminCanvas.height);

            adminCanvas.addEventListener('mousedown', (e) => {
                adminDrawing = true;
                [adminLastX, adminLastY] = [e.offsetX, e.offsetY];
            });
            adminCanvas.addEventListener('mousemove', (e) => {
                if (!adminDrawing) return;
                adminCtx.strokeStyle = document.getElementById('adminColor').value;
                adminCtx.lineWidth = document.getElementById('adminSize').value;
                adminCtx.lineCap = 'round';
                adminCtx.beginPath();
                adminCtx.moveTo(adminLastX, adminLastY);
                adminCtx.lineTo(e.offsetX, e.offsetY);
                adminCtx.stroke();
                [adminLastX, adminLastY] = [e.offsetX, e.offsetY];
            });
            adminCanvas.addEventListener('mouseup', () => adminDrawing = false);
            adminCanvas.addEventListener('mouseout', () => adminDrawing = false);
        }

        function adminTozalash() {
            adminCtx.fillStyle = 'white';
            adminCtx.fillRect(0, 0, adminCanvas.width, adminCanvas.height);
        }

        function adminRasmSaqlash() {
            const dataUrl = adminCanvas.toDataURL('image/png');
            uploadRasm(dataUrl);
        }

        function rasmYuklash() {
            const fileInput = document.getElementById('turnirRasm');
            const file = fileInput.files[0];
            if (!file) {
                alert('Rasm tanlang!');
                return;
            }

            console.log('Fayl tanlandi:', file.name, 'Hajmi:', Math.round(file.size / 1024), 'KB');

            // Katta rasmlarni kichiklashtirish
            const maxSize = 800; // max 800px
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                // Proporsiyani saqlagan holda kichiklashtirish
                if (width > maxSize || height > maxSize) {
                    if (width > height) {
                        height = Math.round(height * maxSize / width);
                        width = maxSize;
                    } else {
                        width = Math.round(width * maxSize / height);
                        height = maxSize;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                console.log('Optimallashtirilgan rasm:', Math.round(dataUrl.length / 1024), 'KB');
                uploadRasm(dataUrl);
            };
            img.src = URL.createObjectURL(file);
        }

        function uploadRasm(dataUrl) {
            // Loading ko'rsatish
            const btn = document.querySelector('.admin-btn.success');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Yuklanmoqda...';
            }

            console.log('Rasm yuborilmoqda, hajmi:', Math.round(dataUrl.length / 1024), 'KB');

            fetch('/turnir/admin/rasm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tur: '{{ tur }}',
                    rasm: dataUrl
                })
            })
            .then(r => {
                console.log('Server javobi:', r.status);
                if (!r.ok) {
                    throw new Error('Server xatosi: ' + r.status);
                }
                return r.json();
            })
            .then(data => {
                console.log('Natija:', data);
                if (data.success) {
                    alert('Rasm qo\'yildi!');
                    location.reload();
                } else {
                    alert(data.xato || 'Xatolik');
                }
            })
            .catch(err => {
                console.error('Xato:', err);
                alert('Xatolik yuz berdi: ' + err.message);
            })
            .finally(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Bu rasmni qo\'yish';
                }
            });
        }

        function goliblarniSaqlash() {
            const golib1 = document.getElementById('golib1').value;
            const golib2 = document.getElementById('golib2').value;
            const golib3 = document.getElementById('golib3').value;
            const coin1 = parseInt(document.getElementById('coin1').value) || 0;
            const coin2 = parseInt(document.getElementById('coin2').value) || 0;
            const coin3 = parseInt(document.getElementById('coin3').value) || 0;

            fetch('/turnir/admin/goliblar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    tur: '{{ tur }}',
                    golib1, golib2, golib3,
                    coin1, coin2, coin3
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('G\'oliblar saqlandi va coinlar berildi!');
                    location.reload();
                } else {
                    alert(data.xato || 'Xatolik');
                }
            });
        }

        function turnirniYangilash() {
            if (!confirm('Yangi turnir boshlashni xohlaysizmi? Eski ma\'lumotlar tarixga o\'tadi.')) return;

            fetch('/turnir/admin/yangilash', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tur: '{{ tur }}' })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Yangi turnir boshlandi!');
                    location.reload();
                } else {
                    alert(data.xato || 'Xatolik');
                }
            });
        }

        // Countdown timer
        {% if turnir %}
        const tugash = new Date('{{ turnir.tugash }}');

        function updateCountdown() {
            const now = new Date();
            const diff = tugash - now;

            if (diff <= 0) {
                document.getElementById('qolgan_vaqt').textContent = 'Turnir tugadi!';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);

            let text = '';
            if (days > 0) text += days + ' kun ';
            text += hours + ' soat ' + mins + ' daqiqa ' + secs + ' soniya';

            document.getElementById('qolgan_vaqt').textContent = text;
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();
        {% endif %}
    </script>
</body>
</html>
